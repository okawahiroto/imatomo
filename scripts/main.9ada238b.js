!function(){"use strict";function a(a,b,c){console.log("GroupController Constructor"),this.$location=a,this.ProfilesService=b,this.GroupsService=c,this.profile=b.getStorageProfile()}angular.module("imatomo.components.group",["imatomo.service.profiles","imatomo.service.groups"]).controller("GroupController",a),a.$inject=["$location","ProfilesService","GroupsService"],a.prototype.activate=function(){console.log("GroupController activate Method"),b=this;var a=b.GroupsService.findGroups();b.items=a},a.prototype.register=function(){if(!b.profile)return b.status="dengire",void(b.message="ユーザ登録を行ってください。");var a={createuserid:b.profile.userid,groupname:b.groupname,members:[{userid:b.profile.userid,username:b.profile.username}]};b.GroupsService.addGroup(a),b.groupname=""},a.prototype.moveDetail=function(a){b.$location.path("/groupdetail/"+a)};var b;a.prototype.closeAlert=function(){console.log("close"),b.status="",b.message=""}}(),function(){"use strict";function a(a,b,c,d){console.log("GroupdetailController Constructor"),this.id=a.id,this.$location=b,this.ProfilesService=c,this.GroupsService=d,this.profile=c.getStorageProfile()}angular.module("imatomo.components.groupdetail",["imatomo.service.profiles","imatomo.service.groups"]).controller("GroupdetailController",a),a.$inject=["$routeParams","$location","ProfilesService","GroupsService"],a.prototype.activate=function(){console.log("GroupdetailController activate Method"),b=this;var a=b.ProfilesService.getProfiles();b.GroupsService.getGroup(b.id,function(c){a.$loaded().then(function(d){var e=a.$getRecord(c.createuserid);e&&(b.createusername=e.username)}),b.group=c})},a.prototype.apply=function(){console.log("GroupdetailController apply Method"),b.GroupsService.addMember(b.group.$id),b.$location.path("group")},a.prototype.dissolution=function(){console.log("GroupdetailController dissolution Method"),b.GroupsService.removeGroup(b.group.$id),b.$location.path("group")},a.prototype.withdrawal=function(){console.log("GroupdetailController withdrawal Method"),b.GroupsService.removeMember(b.group.$id,b.profile.userid,function(){b.$location.path("group")})},a.prototype.isAbleApply=function(){if(!b.group||!b.profile)return!1;if(b.group.createuserid===b.profile.userid)return!1;for(var a=0;a<b.group.members.length;a++)if(b.group.members[a].userid===b.profile.userid)return!1;return!0},a.prototype.isAbleDissolution=function(){return b.group&&b.profile?b.group.createuserid===b.profile.userid:!1},a.prototype.isAbleWithdrawal=function(){if(!b.group||!b.profile)return!1;for(var a=0;a<b.group.members.length;a++)if(b.group.members[a].userid===b.profile.userid)return!0;return!1};var b}(),function(){"use strict";function a(a,b){console.log("ProfileController Constructor"),this.$location=a,this.ProfilesService=b}angular.module("imatomo.components.profile",["imatomo.service.profiles"]).controller("ProfileController",a),a.$inject=["$location","ProfilesService"],a.prototype.activate=function(){console.log("ProfileController activate Method"),b=this;var a=b.ProfilesService.getStorageProfile();return a?void(b.username=a.username):void(b.mode="new")},a.prototype.register=function(){console.log("ProfileController register Method");var a={username:b.username},c=function(a){b.$location.path("shitailist")};"new"===b.mode?b.ProfilesService.addProfile(a,c):b.ProfilesService.modProfile(a,c)},a.prototype.closeAlert=function(){console.log("close"),b.status="",b.message=""};var b}(),function(){"use strict";function a(a,b,c,d){console.log("ShitaiController Constructor"),this.$location=a,this.ShitaiesService=b,this.ProfilesService=c,this.GroupsService=d,this.profile=c.getStorageProfile()}angular.module("imatomo.components.shitai",["imatomo.service.shitaies","imatomo.service.profiles","imatomo.service.groups"]).controller("ShitaiController",a),a.$inject=["$location","ShitaiesService","ProfilesService","GroupsService"],a.prototype.activate=function(){console.log("ShitaiController activate Method"),b=this;var a=[],c={groupid:"",groupname:"みんな"};a.push(c);var d=b.GroupsService.findGroups();d.$loaded().then(function(c){for(var e=0;e<d.length;e++)for(var f=0;f<d[e].members.length;f++)if(d[e].members[f].userid===b.profile.userid){var g={groupid:d[e].$id,groupname:d[e].groupname};a.push(g)}b.groupList=a,b.groupList.groupid=b.groupList[0].groupid});var e=new Date;b.today=e,b.time=(new Date).setHours(e.getHours()+1,0,0,0)},a.prototype.register=function(){console.log("ShitaiController register Method");var a=b.ProfilesService.getStorageProfile();if(!a)return b.status="dengire",void(b.message="ユーザ登録を行ってください。");var c=b.date;if(c.setHours(new Date(b.time).getHours(),new Date(b.time).getMinutes(),59,0),c.getTime()<(new Date).getTime())return b.status="dengire",void(b.message="期限に過去が設定されています。");var d={userid:a.userid,title:b.title,time:c.getTime(),comment:void 0===b.comment?"":b.comment,place:void 0===b.place?"":b.place,group:void 0===b.groupList.groupid?"":b.groupList.groupid,createtimestamp:Firebase.ServerValue.TIMESTAMP};b.ShitaiesService.addShitai(d,function(){b.$location.path("shitailist")})};var b;a.prototype.closeAlert=function(){console.log("close"),b.status="",b.message=""}}(),function(){"use strict";function a(a,b,c,d,e){console.log("ShitaidetailController Constructor"),this.$location=a,this.id=b.id,this.ShitaiesService=c,this.ProfilesService=d,this.profile=d.getStorageProfile(),this.GroupsService=e}angular.module("imatomo.components.shitaidetail",["imatomo.service.shitaies","imatomo.service.profiles","imatomo.service.groups"]).controller("ShitaidetailController",a),a.$inject=["$location","$routeParams","ShitaiesService","ProfilesService","GroupsService"],a.prototype.activate=function(){console.log("ShitaidetailController activate Method"),b=this,b.ShitaiesService.getShitai(b.id,c)};var b,c=function(a){b.id=a.$id,b.userid=a.userid,b.title=a.title,b.time=a.time,b.place=a.place,b.comment=a.comment,b.createtimesstamp=a.createtimesstamp;var c=b.ProfilesService.getProfiles();c.$loaded().then(function(d){var e=c.$getRecord(a.userid);e&&(b.username=e.username)});var d="みんな",e=b.GroupsService.findGroups();e.$loaded().then(function(c){for(var f=0;f<e.length;f++)if(e[f].$id===a.group){d=e[f].groupname;break}b.group=d}),b.approvals=a.approvals};a.prototype.shitaiDelete=function(){console.log("ShitaidetailController shitaiDelete Method");for(var a=b.ShitaiesService.findShitaies(),c=0;c<a.length;c++)b.id===a[c].$id&&(console.log(a[c]),a.$remove(c));b.$location.path("/shitailist/")},a.prototype.approval=function(a){console.log("ShitaidetailController approval Method"),b.ShitaiesService.approval(a),b.ShitaiesService.getShitai(b.id,c)},a.prototype.cancel=function(a){console.log("ShitaidetailController cancel Method"),b.ShitaiesService.cancel(a),b.ShitaiesService.getShitai(b.id,c)},a.prototype.isApproval=function(a){if(!b.profile)return!1;if(a.userid===b.profile.userid)return!1;if(!a.approvals)return!0;var c=!0;return a.approvals.forEach(function(a){a.userid===b.profile.userid&&(c=!1)}),c},a.prototype.isCancel=function(a){if(!b.profile)return!1;if(a.userid===b.profile.userid)return!1;if(!a.approvals)return!1;var c=!1;return a.approvals.forEach(function(a){a.userid===b.profile.userid&&(c=!0)}),c}}(),function(){"use strict";function a(a,b,c,d){console.log("ShitailistController Constructor"),this.ShitaiesService=b,this.ProfilesService=c,this.$location=a,this.GroupsService=d}angular.module("imatomo.components.shitailist",["imatomo.service.shitaies","imatomo.service.profiles","imatomo.service.groups"]).controller("ShitailistController",a),a.$inject=["$location","ShitaiesService","ProfilesService","GroupsService"],a.prototype.activate=function(){console.log("ShitailistController activate Method"),b=this,b.profile=b.ProfilesService.getStorageProfile();var a=b.GroupsService.findGroups();a.$loaded().then(function(c){b.groupList=a;var d=b.ShitaiesService.findShitaies();b.items=d}),b.filterDate=(new Date).getTime()},a.prototype.searchMyApprovals=function(){console.log("ShitailistController searchMyApprovals Method"),console.log(b.items),console.log(b.items.length);var a=b.items[0].approvals.length;console.log(a);for(var c=0;c<b.items.length;c++){console.log(b.items[c].approvals);for(var d=0;d<b.items[c].approvals.length;d++)return b.items[c].approvals[d].userid===b.profile.userid?(console.log("b"),console.log(c),console.log(d),console.log(b.items[c].$id),console.log(b.items[c].approvals[d].userid),!0):!1}},a.prototype.approval=function(a){console.log("ShitailistController approval Method"),b.ShitaiesService.approval(a)},a.prototype.cancel=function(a){console.log("ShitailistController approval Method"),b.ShitaiesService.cancel(a)},a.prototype.isApproval=function(a){if(!b.profile)return!1;if(a.userid===b.profile.userid)return!1;if(!a.approvals)return!0;var c=!0;return a.approvals.forEach(function(a){a.userid===b.profile.userid&&(c=!1)}),c},a.prototype.isCancel=function(a){if(!b.profile)return!1;if(a.userid===b.profile.userid)return!1;if(!a.approvals)return!1;var c=!1;return a.approvals.forEach(function(a){a.userid===b.profile.userid&&(c=!0)}),c},a.prototype.moveDetail=function(a){console.log("ShitailistController moveDetail Method"),b.$location.path("/shitaidetail/"+a)},a.prototype.searchMember=function(a){if(console.log("ShitailistController searchMember Method"),""===a.group)return!0;if(void 0!==b.groupList)return!0;for(var c=0;c<b.groupList.length;c++)if(b.groupList[c].$id===a.group)for(var d=0;d<b.groupList[c].members.length;d++)if(b.groupList[c].members[d].userid===b.profile.userid)return!0;return!1};var b}(),function(){"use strict";function a(a){return function(b,c,d){var e=a.getProfiles();a.getProfiles().$loaded().then(function(a){var b=e.$getRecord(d.userid);b&&c.append(b.username)})}}angular.module("imatomo.directives.userid",["imatomo.service.profiles"]).directive("userid",a),a.$inject=["ProfilesService"]}(),function(){"use strict";function a(a){a.html5Mode(!1)}angular.module("imatomo.config",[]).config(a),a.$inject=["$locationProvider"]}(),function(){"use strict";function a(a,b){var c=new Firebase("https://resplendent-inferno-2076.firebaseio.com/groups"),d=a(c),e={findGroups:function(){return d},getGroup:function(a,b){d.$loaded().then(function(c){b&&b(d.$getRecord(a))})},addGroup:function(a,b){d.$add(a).then(function(){b&&b()})},addMember:function(a,c){d.$loaded().then(function(c){var e=b.getStorageProfile(),f=d.$getRecord(a);f.members||(f.members=[]),f.members.push({userid:e.userid,username:e.username}),d.$save(f)})},removeMember:function(a,c,f){d.$loaded().then(function(c){var g=b.getStorageProfile(),h=d.$getRecord(a),i=h.members.filter(function(a){return a.userid!==g.userid});return 0===i.length?void e.removeGroup(a,f):(h.members=i,d.$save(h),void(f&&f()))})},removeGroup:function(a,b){d.$loaded().then(function(c){var e=d.$getRecord(a);e&&d.$remove(e).then(function(a){b&&b()})})}};return e}angular.module("imatomo.service.groups",["imatomo.service.profiles"]).factory("GroupsService",a),a.$inject=["$firebaseArray","ProfilesService"]}(),function(){"use strict";function a(a){var b=a("/api/gruntfiles",{query:{transformResponse:function(a){return angular.fromJson(a)}}});return b}angular.module("imatomo.service.gruntfiles",["ngResource"]).factory("GruntfilesService",a),a.$inject=["$resource"]}(),function(){"use strict";function a(a){var b=new Firebase("https://resplendent-inferno-2076.firebaseio.com/profiles"),c=a(b),d={getStorageProfile:function(){var a=window.localStorage,b=a.getItem("profile");return b?JSON.parse(b):void 0},getProfiles:function(){return c},addProfile:function(a,b){c.$add(a).then(function(c){var d=c.key();a.userid=d,window.localStorage.setItem("profile",JSON.stringify(a)),b&&b(c)})},modProfile:function(a,b){var d=this.getStorageProfile().userid;c.$loaded().then(function(e){var f=c.$getRecord(d);f.username=a.username,c.$save(f),a.userid=d,window.localStorage.setItem("profile",JSON.stringify(a)),b&&b(a)})}};return d}angular.module("imatomo.service.profiles",[]).factory("ProfilesService",a),a.$inject=["$firebaseArray"]}(),function(){"use strict";function a(a,c,d){var e=a(b),f={findShitaies:function(){return e},getShitai:function(a,b){e.$loaded().then(function(c){b&&b(e.$getRecord(a))})},addShitai:function(a,b){f.selfApproval=!0,e.$add(a).then(function(a){b&&b()})},approval:function(a){e.$loaded().then(function(b){var d=c.getStorageProfile(),f=e.$getRecord(a);f.approvals||(f.approvals=[]),f.approvals.push({userid:d.userid}),f.lastApprovalUserid=d.userid,e.$save(f)})},cancel:function(a,b){e.$loaded().then(function(d){var f=c.getStorageProfile(),g=e.$getRecord(a),h=g.approvals.filter(function(a){return a.userid!==f.userid});g.approvals=h,g.lastApprovalUserid="",e.$save(g),b&&b()})}};return Object.defineProperty(f,"selfApproval",{value:!1,writable:!0}),e.$watch(function(a){if(console.log("event.event="+a.event),"child_changed"===a.event){var b=c.getStorageProfile(),g=e.$getRecord(a.key);if(f.selfApproval)return console.log("shitaiesService.selfApproval="+f.selfApproval),console.log("自分の $add child_changed だったら何もしない"),void(f.selfApproval=!1);if(console.log("shitai.lastApprovalUserid = "+g.lastApprovalUserid),!g.lastApprovalUserid)return void console.log("賛同する更新じゃなければ無視");if(g.userid!==b.userid)return console.log(g.userid+"!=="+b.userid),void console.log("自分以外が登録したものなら無視する");var h=g.lastApprovalUserid,i=c.getProfiles().$getRecord(h);d.pop("success","仲間があらわれた！",i.username+" さんがあなたに賛同しました。"),console.log("仲間があらわれた！！！！！！！！！！！！！！！");var j=new Audio($("base").prop("href")+"audio/linelike.mp3");j.play()}}),f}angular.module("imatomo.service.shitaies",["imatomo.service.profiles"]).factory("ShitaiesService",a),a.$inject=["$firebaseArray","ProfilesService","toaster"];var b=new Firebase("https://resplendent-inferno-2076.firebaseio.com/shitaies")}(),function(){"use strict";function a(a,b){a.$on("event:google-plus-signin-success",function(a,c){var d=b("https://www.googleapis.com/oauth2/v2/userinfo?alt=json&access_token="+c.access_token,{}),e=d.get().$promise;e.then(function(a){alert(a.name)})["catch"](function(a){console.log(a)})}),a.$on("event:google-plus-signin-failure",function(a,b){console.log(b)})}angular.module("imatomo",["ngNewRouter","imatomo.config","firebase","toaster","ngAnimate","ngResource","ui.bootstrap","directive.g+signin","imatomo.directives.userid","imatomo.components.shitailist","imatomo.components.shitai","imatomo.components.group","imatomo.components.profile","imatomo.components.shitaidetail","imatomo.components.groupdetail"]).controller("AppController",a),a.$routeConfig=[{path:"/",redirectTo:"/shitailist"},{path:"/shitailist",component:"shitailist"},{path:"/shitai",component:"shitai"},{path:"/group",component:"group"},{path:"/profile",component:"profile"},{path:"/shitaidetail/:id",component:"shitaidetail"},{path:"/groupdetail/:id",component:"groupdetail"}],a.$inject=["$scope","$resource"]}();